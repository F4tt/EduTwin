name: Deploy to AWS ECS

on:
  push:
    branches: [master]
  workflow_dispatch:  # Allow manual trigger

env:
  AWS_REGION: us-east-1
  ECR_BACKEND: 339712865058.dkr.ecr.us-east-1.amazonaws.com/edutwin-backend
  ECR_FRONTEND: 339712865058.dkr.ecr.us-east-1.amazonaws.com/edutwin-frontend
  ECS_CLUSTER: edutwin-cluster
  ECS_SERVICE_BACKEND: edutwin-backend
  ECS_SERVICE_FRONTEND: edutwin-frontend
  # Resource limits to prevent OOM during builds
  DOCKER_BUILDKIT: 1
  BUILDKIT_PROGRESS: plain

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: 3600

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Verify ECR repositories exist
        run: |
          echo "üîç Checking ECR repositories..."
          
          # Check backend repository
          if aws ecr describe-repositories --repository-names edutwin-backend >/dev/null 2>&1; then
            echo "‚úÖ Backend ECR repository exists"
          else
            echo "‚ùå Backend ECR repository not found. Creating..."
            aws ecr create-repository --repository-name edutwin-backend
            echo "‚úÖ Backend ECR repository created"
          fi
          
          # Check frontend repository  
          if aws ecr describe-repositories --repository-names edutwin-frontend >/dev/null 2>&1; then
            echo "‚úÖ Frontend ECR repository exists"
          else
            echo "‚ùå Frontend ECR repository not found. Creating..."
            aws ecr create-repository --repository-name edutwin-frontend
            echo "‚úÖ Frontend ECR repository created"
          fi

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            
      - name: Free up space
        run: |
          echo "üßπ Cleaning up space before build..."
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt-get clean
          sudo docker system prune -af --volumes
          df -h

      - name: Build and push Backend image
        id: backend-build
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile.prod
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.ECR_BACKEND }}:latest
            ${{ env.ECR_BACKEND }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
        timeout-minutes: 20

      - name: Verify Backend build success
        run: |
          if [ "${{ steps.backend-build.outcome }}" != "success" ]; then
            echo "‚ùå Backend build failed"
            exit 1
          fi
          echo "‚úÖ Backend build completed successfully"

      - name: Build and push Frontend image
        id: frontend-build  
        uses: docker/build-push-action@v5
        with:
          context: ./frontend_react
          file: ./frontend_react/Dockerfile.prod
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.ECR_FRONTEND }}:latest
            ${{ env.ECR_FRONTEND }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1
        timeout-minutes: 15

      - name: Verify Frontend build success
        run: |
          if [ "${{ steps.frontend-build.outcome }}" != "success" ]; then
            echo "‚ùå Frontend build failed"
            exit 1
          fi
          echo "‚úÖ Frontend build completed successfully"

      - name: Wait for ECR propagation
        run: |
          echo "‚è≥ Waiting for ECR image propagation..."
          sleep 30
          echo "‚úÖ Propagation wait completed"
      
      - name: Verify images in ECR
        run: |
          echo "üîç Verifying images were pushed successfully..."
          
          # Check backend image with proper error handling
          echo "Checking backend image..."
          if aws ecr describe-images --repository-name edutwin-backend --image-ids imageTag=latest >/dev/null 2>&1; then
            echo "‚úÖ Backend image found in ECR"
            aws ecr describe-images \
              --repository-name edutwin-backend \
              --image-ids imageTag=latest \
              --query 'imageDetails[0].{Tags:imageTags,Size:imageSizeInBytes,Pushed:imagePushedAt}' \
              --output table
          else
            echo "‚ùå Backend image not found in ECR"
            echo "Available images in backend repository:"
            aws ecr describe-images --repository-name edutwin-backend --query 'imageDetails[*].imageTags' --output table || echo "No images found"
            exit 1
          fi
          
          # Check frontend image with proper error handling  
          echo "Checking frontend image..."
          if aws ecr describe-images --repository-name edutwin-frontend --image-ids imageTag=latest >/dev/null 2>&1; then
            echo "‚úÖ Frontend image found in ECR"
            aws ecr describe-images \
              --repository-name edutwin-frontend \
              --image-ids imageTag=latest \
              --query 'imageDetails[0].{Tags:imageTags,Size:imageSizeInBytes,Pushed:imagePushedAt}' \
              --output table
          else
            echo "‚ùå Frontend image not found in ECR"
            echo "Available images in frontend repository:"
            aws ecr describe-images --repository-name edutwin-frontend --query 'imageDetails[*].imageTags' --output table || echo "No images found"
            exit 1
          fi

      - name: Prepare ECS task definitions
        run: |
          echo "üîß Preparing task definitions..."
          
          # Get AWS Account ID properly
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "AWS Account ID: $AWS_ACCOUNT_ID"
          
          # Replace AWS_ACCOUNT_ID placeholders
          echo "Processing backend task definition..."
          sed "s/\${AWS_ACCOUNT_ID}/$AWS_ACCOUNT_ID/g" \
            backend-task-definition.json > backend-task-definition-processed.json
            
          echo "Processing frontend task definition..."  
          sed "s/\${AWS_ACCOUNT_ID}/$AWS_ACCOUNT_ID/g" \
            frontend-task-definition.json > frontend-task-definition-processed.json
          
          echo "‚úÖ Task definitions processed"
          
          # Validate task definitions
          echo "üîç Validating task definitions..."
          
          # Check if backend task definition is valid JSON
          if ! jq empty backend-task-definition-processed.json >/dev/null 2>&1; then
            echo "‚ùå Backend task definition is not valid JSON"
            cat backend-task-definition-processed.json
            exit 1
          fi
          
          # Check if frontend task definition is valid JSON
          if ! jq empty frontend-task-definition-processed.json >/dev/null 2>&1; then
            echo "‚ùå Frontend task definition is not valid JSON"  
            cat frontend-task-definition-processed.json
            exit 1
          fi
          
          echo "‚úÖ Task definitions validation passed"

      - name: Deploy Backend to ECS
        id: backend-deploy
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: backend-task-definition-processed.json
          service: ${{ env.ECS_SERVICE_BACKEND }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: false
          force-new-deployment: true

      - name: Deploy Frontend to ECS
        id: frontend-deploy
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: frontend-task-definition-processed.json
          service: ${{ env.ECS_SERVICE_FRONTEND }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: false
          force-new-deployment: true

      - name: Monitor Backend deployment
        timeout-minutes: 30
        run: |
          echo "‚è≥ Monitoring Backend deployment stability..."
          echo "‚ÑπÔ∏è  Extended timeout (30 min) for complete deployment cycle"
          
          # Function to check service health with detailed info
          check_service_health() {
            local service_name="$1"
            
            if ! aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services "$service_name" \
              --query 'services[0]' > service_status.json 2>/dev/null; then
              echo "‚ùå Failed to describe service $service_name"
              return 1
            fi
            
            # Check if service exists
            if [ "$(jq -r '.serviceName // "null"' service_status.json)" = "null" ]; then
              echo "‚ùå Service $service_name not found"
              return 1
            fi
            
            local running_count=$(jq -r '.runningCount // 0' service_status.json)
            local desired_count=$(jq -r '.desiredCount // 0' service_status.json)
            local pending_count=$(jq -r '.pendingCount // 0' service_status.json)
            local status=$(jq -r '.status // "UNKNOWN"' service_status.json)
            
            echo "Service Status: $status | Running: $running_count | Desired: $desired_count | Pending: $pending_count"
            
            # Service is stable if running count matches desired and no pending
            if [ "$running_count" -eq "$desired_count" ] && [ "$running_count" -gt "0" ] && [ "$pending_count" -eq "0" ] && [ "$status" = "ACTIVE" ]; then
              echo "‚úÖ Service $service_name is stable!"
              return 0
            fi
            return 1
          }
          
          # Wait with comprehensive retry logic
          max_attempts=60  # 60 * 30 seconds = 30 minutes
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            echo "üîÑ Attempt $attempt/$max_attempts - Checking backend service..."
            
            if check_service_health "${{ env.ECS_SERVICE_BACKEND }}"; then
              echo "üéâ Backend service deployment successful!"
              break
            fi
            
            # Show recent events every 5 attempts for debugging
            if [ $((attempt % 5)) -eq 0 ]; then
              echo "üìã Recent service events:"
              aws ecs describe-services \
                --cluster ${{ env.ECS_CLUSTER }} \
                --services ${{ env.ECS_SERVICE_BACKEND }} \
                --query 'services[0].events[0:3].[createdAt,message]' \
                --output table 2>/dev/null || echo "No events available"
              
              echo "üîç Current tasks:"
              aws ecs list-tasks \
                --cluster ${{ env.ECS_CLUSTER }} \
                --service-name ${{ env.ECS_SERVICE_BACKEND }} \
                --query 'taskArns[*]' \
                --output text 2>/dev/null | head -3 | while read task; do
                if [ ! -z "$task" ]; then
                  aws ecs describe-tasks \
                    --cluster ${{ env.ECS_CLUSTER }} \
                    --tasks "$task" \
                    --query 'tasks[0].{TaskArn:taskArn,LastStatus:lastStatus,HealthStatus:healthStatus,CreatedAt:createdAt}' \
                    --output table 2>/dev/null || echo "Task details unavailable"
                fi
              done
            fi
            
            if [ $attempt -eq $max_attempts ]; then
              echo "‚ùå Backend service failed to stabilize after 30 minutes"
              
              # Final debugging info
              echo "üîç Final service status:"
              cat service_status.json | jq '.' 2>/dev/null || echo "Service status unavailable"
              
              echo "üîç All events:"
              aws ecs describe-services \
                --cluster ${{ env.ECS_CLUSTER }} \
                --services ${{ env.ECS_SERVICE_BACKEND }} \
                --query 'services[0].events[0:10].[createdAt,message]' \
                --output table 2>/dev/null || echo "Events unavailable"
              
              exit 1
            fi
            
            sleep 30
            attempt=$((attempt + 1))
          done

      - name: Monitor Frontend deployment
        timeout-minutes: 10
        run: |
          echo "‚è≥ Monitoring Frontend deployment..."
          
          # Simple wait for frontend (lighter workload)
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE_FRONTEND }} || {
            echo "‚ùå Frontend deployment failed"
            aws ecs describe-services \
              --cluster ${{ env.ECS_CLUSTER }} \
              --services ${{ env.ECS_SERVICE_FRONTEND }} \
              --query 'services[0].events[0:3]' \
              --output table
            exit 1
          }
          
          echo "‚úÖ Frontend deployment successful!"

      - name: Run post-deployment health checks
        run: |
          echo "üè• Running post-deployment health checks..."
          
          # Get service endpoints
          backend_tasks=$(aws ecs list-tasks \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service-name ${{ env.ECS_SERVICE_BACKEND }} \
            --query 'taskArns' --output text)
          
          if [ ! -z "$backend_tasks" ]; then
            echo "‚úÖ Backend tasks are running"
          else
            echo "‚ùå No backend tasks found"
            exit 1
          fi
          
          # Test application endpoint (if load balancer is ready)
          echo "üåê Testing application availability..."
          timeout 60 bash -c 'until curl -s https://edutwin.online/health; do echo "Waiting for app..."; sleep 5; done' || \
            echo "‚ö†Ô∏è  App endpoint not yet responding (may need DNS propagation time)"

      - name: Deployment Summary
        run: |
          echo "üìä === DEPLOYMENT SUMMARY ===" 
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Application: https://edutwin.online"  
          echo "üì¶ Backend image: ${{ env.ECR_BACKEND }}:${{ github.sha }}"
          echo "üì¶ Frontend image: ${{ env.ECR_FRONTEND }}:${{ github.sha }}"
          echo "üìÖ Deployed at: $(date -u)"
          echo ""
          echo "üîç Service Status:"
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE_BACKEND }} ${{ env.ECS_SERVICE_FRONTEND }} \
            --query 'services[].[serviceName,status,runningCount,desiredCount]' \
            --output table
          
          echo ""
          echo "üéØ Deployment completed in job #${{ github.run_number }}"
